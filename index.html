<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Noticias sobre Autismo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#5c6bc0">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --bg: #f7f9fc;
      --card: #fff;
      --accent: #5c6bc0;
      --text: #333;
      --muted: #777;
      --column-bg-es: #e8f0fe;
      --column-bg-en: #fce8e8;
    }
    *, *::before, *::after {margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family: 'Poppins', sans-serif;
      background:var(--bg);
      color:var(--text);
      padding:20px 12px;
      -webkit-tap-highlight-color: transparent;
      -webkit-text-size-adjust: 100%;
      -webkit-font-smoothing: antialiased;
    }
    header{
      text-align:center;
      margin-bottom:30px;
      position: relative;
      background-image: url('https://www.comunidad.madrid/sites/default/files/styles/image_style_16_9/public/img/logos-simbolos/shutterstock_1040626540.jpg?itok=yPO3qvf4');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      padding: 40px 20px;
      border-radius: 12px;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
    }
    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 12px;
      z-index: 1;
    }
    header * {
      position: relative;
      z-index: 2;
    }
    header h1{
      font-size:1.8rem;
      font-weight:600;
      margin-bottom:8px;
    }
    header p{
      color: rgba(255, 255, 255, 0.9);
      font-size:0.8rem;
      margin-bottom: 20px;
    }
    .language-toggle {
      position: absolute;
      top: 15px;
      right: 15px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      z-index: 3;
    }
    .language-toggle:active {
      transform: scale(0.95);
    }
    .column{
      background:var(--card);
      border-radius:12px;
      padding:18px;
      box-shadow:0 3px 10px rgba(0,0,0,.08);
      width: 100%;
      display: none;
    }
    .column.active {
      display: block;
    }
    .column-es{
      background:var(--column-bg-es);
      display: block; /* Mostrar español por defecto */
    }
    .column-en{
      background:var(--column-bg-en);
    }
    .column-header{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      margin-bottom:18px;
      padding-bottom:10px;
      border-bottom:2px solid var(--accent);
    }
    .column-header h2 {
      font-size:1.3rem;
    }
    .news-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:18px;
    }
    .card{
      background:var(--card);
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 3px 6px rgba(0,0,0,.06);
      transition:transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:active{
      transform: scale(0.98);
    }
    .card img{
      width:100%;
      height:160px;
      object-fit:cover;
    }
    .card-content{
      padding:16px;
    }
    .card-content h3{
      font-size:1.05rem;
      line-height:1.4;
      margin-bottom:10px;
    }
    .card-content .source{
      font-size:.82rem;
      color:var(--muted);
      margin-bottom:8px;
    }
    .card-content .date{
      font-size:.78rem;
      color:var(--accent);
      margin-bottom:8px;
    }
    .card-content .description{
      font-size:.87rem;
      color:var(--muted);
      margin-bottom:12px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .card-content a{
      display: inline-block;
      color:var(--accent);
      font-weight:600;
      text-decoration:none;
      padding: 4px 0;
    }
    .loading{
      text-align:center;
      padding:50px 20px;
      color:var(--muted);
    }
    .load-more{
      display:block;
      margin:25px auto;
      padding:14px 30px;
      border:none;
      border-radius:30px;
      background:var(--accent);
      color:#fff;
      font-weight:600;
      cursor:pointer;
      transition:.3s;
      box-shadow:0 2px 6px rgba(0,0,0,.1);
      min-width: 180px;
      min-height: 48px;
      touch-action: manipulation;
    }
    .load-more:active{
      background:#455a64;
      transform:scale(0.97);
    }
    .load-more:disabled{
      background:var(--muted);
      cursor:not-allowed;
    }
    /* ===== ESTILO PARA EL BOTÓN DE TRADUCCIÓN (NUEVO) ===== */
    .translate-btn {
        background-color: #e8eaf6;
        color: var(--accent);
        border: 1px solid var(--accent);
        padding: 6px 12px;
        font-size: 0.8rem;
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        cursor: pointer;
        margin-top: 8px;
        margin-bottom: 8px;
        align-self: flex-start;
        transition: all 0.3s ease;
        border-radius: 20px;
    }
    .translate-btn:hover {
        background-color: var(--accent);
        color: #fff;
    }
    .translate-btn:disabled {
        border-color: var(--muted);
        color: var(--muted);
        cursor: not-allowed;
        background-color: #f0f0f0;
    }
    /* ======================================================= */
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
      border-left: 4px solid #c62828;
      text-align: center;
      font-size: 0.9rem;
    }
    .api-status {
      background: #e8f5e8;
      color: #2e7d32;
      padding: 10px 12px;
      border-radius: 8px;
      margin: 10px auto;
      max-width: 600px;
      border-left: 4px solid #4caf50;
      text-align: center;
      font-size: 0.85rem;
    }
    .back-button {
      display: block;
      margin: 20px auto;
      padding: 10px 20px;
      background: var(--muted);
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    
    @media(max-width:768px){
      header h1 {
        font-size: 1.6rem;
      }
      .language-toggle {
        top: 10px;
        right: 10px;
        padding: 6px 12px;
        font-size: 0.8rem;
      }
      .column-header h2 {
        font-size: 1.2rem;
      }
      .card img {
        height: 140px;
      }
    }
    @media(max-width:480px){
      body {
        padding: 15px 10px;
      }
      header {
        margin-bottom: 20px;
        padding: 30px 15px;
      }
      header h1 {
        font-size: 1.4rem;
      }
      header p {
        font-size: 0.75rem;
      }
      .language-toggle {
        padding: 5px 10px;
        font-size: 0.75rem;
      }
      .card-content {
        padding: 14px;
      }
      .card-content h3 {
        font-size: 1rem;
      }
      .news-grid {
        gap: 15px;
      }
    }
    /* Animations for cards */
    .card {
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card.visible {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <header>
    <h1>NOTICIAS SOBRE AUTISMO</h1>
    <p>Desarrollado con ❤️ para familias y profesionales</p>
    <button id="language-toggle" class="language-toggle">
      <i class="fas fa-language"></i> Ver en inglés
    </button>
  </header>

  <div id="api-status" class="api-status" style="display: none;">
    <i class="fas fa-check-circle"></i> 
    Conectado a APIs de noticias en tiempo real
  </div>

  <div id="column-es" class="column column-es">
    <div class="column-header">
      <i class="fas fa-language"></i>
      <h2>Noticias en Español</h2>
    </div>
    <div id="news-es" class="news-grid">
      <div class="loading"><i class="fas fa-spinner fa-spin"></i> Cargando noticias…</div>
    </div>
    <button id="load-more-es" class="load-more">Cargar más noticias</button>
  </div>

  <div id="column-en" class="column column-en">
    <div class="column-header">
      <i class="fas fa-language"></i>
      <h2>News in English</h2>
    </div>
    <div id="news-en" class="news-grid">
      <div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading news…</div>
    </div>
    <button id="load-more-en" class="load-more">Load more news</button>
    <button id="back-button" class="back-button">Volver a español</button>
  </div>

  <script>
    // API Configuration
    const API_KEYS = {
      GNEWS: '42dd93284a0abf72a9a646d3b4a9c33e',
      NEWSAPI: 'aaf83dcbd8694668ad89247b959db678',
      NEWSDATA: 'pub_a6e9ca27cc1644bf9a1cff0b8686b3eb'
    };

    const articlesPerPage = 6;
    
    // Keywords for autism-related content
    const autismKeywords = [
      'autismo','autista','autismo infantil','trastorno del espectro autista','tea',
      'autism','autistic','autism spectrum disorder','asd','asperger','neurodiversity',
      'neurodivergent', 'stimming', 'meltdown', 'sensory processing'
    ];

    // Terms that might cause false positives
    const falsePositiveTerms = ['bebida', 'infusión', 'té', 'tea drink', 'herbal tea', 'chai tea', 
                                'green tea', 'black tea', 'tea party', 'tea time', 'té verde', 
                                'té negro', 'té rojo', 'té blanco'];

    // DOM references
    const newsEsContainer = document.getElementById('news-es');
    const newsEnContainer = document.getElementById('news-en');
    const loadMoreEsBtn = document.getElementById('load-more-es');
    const loadMoreEnBtn = document.getElementById('load-more-en');
    const apiStatus = document.getElementById('api-status');
    const languageToggle = document.getElementById('language-toggle');
    const backButton = document.getElementById('back-button');
    const columnEs = document.getElementById('column-es');
    const columnEn = document.getElementById('column-en');

    // State
    let currentPageEs = 1;
    let currentPageEn = 1;
    let allArticlesEs = [];
    let allArticlesEn = [];
    let isLoadingEs = false;
    let isLoadingEn = false;
    let seenArticleIdsEs = new Set();
    let seenArticleIdsEn = new Set();

    // Generate a unique ID for an article based on title and source
    function generateArticleId(article) {
      const titlePart = article.title ? article.title.substring(0, 30).replace(/\s+/g, '_') : 'no_title';
      const sourcePart = article.source && article.source.name ? 
                           article.source.name.replace(/\s+/g, '_') : 'no_source';
      return `${titlePart}_${sourcePart}`;
    }

    // Improved function to check if article is autism-related
    function isAutismRelated(article) {
      if (!article.title && !article.description) return false;
      
      const text = (article.title + ' ' + (article.description || '')).toLowerCase();
      
      // First check for false positives (terms that indicate it's NOT about autism)
      const isFalsePositive = falsePositiveTerms.some(term => 
        text.includes(term.toLowerCase())
      );
      
      if (isFalsePositive) {
        return false;
      }
      
      // Then check for autism-related keywords
      const isRelated = autismKeywords.some(keyword => 
        text.includes(keyword.toLowerCase())
      );
      
      return isRelated;
    }

    // Filter out duplicate articles
    function filterDuplicates(articles, seenIds) {
      return articles.filter(article => {
        const articleId = generateArticleId(article);
        if (seenIds.has(articleId)) {
          return false;
        }
        seenIds.add(articleId);
        return true;
      });
    }

    // Fetch from GNews API
    async function fetchFromGNews(lang, page = 1) {
      try {
        const query = lang === 'es' ? 'autismo OR "trastorno del espectro autista" OR TEA' : 'autism OR "autism spectrum disorder" OR ASD';
        const country = lang === 'es' ? 'es' : 'us';
        
        const url = `https://gnews.io/api/v4/search?q=${encodeURIComponent(query)}&lang=${lang}&country=${country}&max=10&apikey=${API_KEYS.GNEWS}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.articles) {
          return data.articles
            .filter(article => 
              article.title && 
              article.url && 
              article.source &&
              !article.title.toLowerCase().includes('[removed]') &&
              isAutismRelated(article)
            )
            .map(article => ({
              ...article,
              urlToImage: article.image
            }));
        }
        return [];
      } catch (error) {
        console.warn('GNews API error:', error);
        return [];
      }
    }

    // Fetch from NewsAPI
    async function fetchFromNewsAPI(lang, page = 1) {
      try {
        const query = lang === 'es' ? 'autismo OR "trastorno del espectro autista"' : 'autism OR "autism spectrum disorder"';
        const from = new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];
        
        const proxyUrl = 'https://corsproxy.io/?';
        const targetUrl = `https://newsapi.org/v2/everything?q=${encodeURIComponent(query)}&language=${lang}&from=${from}&sortBy=publishedAt&pageSize=20&page=${page}&apiKey=${API_KEYS.NEWSAPI}`;
        
        const response = await fetch(proxyUrl + encodeURIComponent(targetUrl));
        const data = await response.json();
        
        if (data.articles) {
          return data.articles.filter(article => 
            article.title && 
            article.url && 
            article.source &&
            !article.title.toLowerCase().includes('[removed]') &&
            isAutismRelated(article)
          );
        }
        return [];
      } catch (error) {
        console.warn('NewsAPI error:', error);
        return [];
      }
    }

    // Fetch from NewsData API
    async function fetchFromNewsData(lang, page = 1) {
      try {
        const query = lang === 'es' ? 'autismo,autista,TEA' : 'autism,autistic,ASD';
        const language = lang === 'es' ? 'es' : 'en';
        
        const url = `https://newsdata.io/api/1/news?apikey=${API_KEYS.NEWSDATA}&q=${query}&language=${language}&category=health`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.results) {
          return data.results.filter(article => 
            article.title && 
            article.link && 
            article.source_id &&
            isAutismRelated(article)
          ).map(article => ({
            title: article.title,
            description: article.description,
            url: article.link,
            urlToImage: article.image_url,
            publishedAt: article.pubDate,
            source: { name: article.source_id }
          }));
        }
        return [];
      } catch (error) {
        console.warn('NewsData API error:', error);
        return [];
      }
    }

    // Main fetch function that tries all APIs
    async function fetchNews(lang, page = 1) {
      let articles = [];
      const seenIds = lang === 'es' ? seenArticleIdsEs : seenArticleIdsEn;
      
      try {
        // Try GNews first (usually fastest and most reliable)
        console.log(`Fetching from GNews API for ${lang}...`);
        let gnewsArticles = await fetchFromGNews(lang, page);
        gnewsArticles = filterDuplicates(gnewsArticles, seenIds);
        articles = [...articles, ...gnewsArticles];
        
        // Si no tenemos suficientes artículos, intentamos con NewsAPI
        if (articles.length < 5) {
          console.log(`Trying NewsAPI for ${lang}...`);
          let newsApiArticles = await fetchFromNewsAPI(lang, page);
          newsApiArticles = filterDuplicates(newsApiArticles, seenIds);
          articles = [...articles, ...newsApiArticles];
        }
        
        // Si todavía no tenemos suficientes, intentamos con NewsData
        if (articles.length < 5) {
          console.log(`Trying NewsData for ${lang}...`);
          let newsDataArticles = await fetchFromNewsData(lang, page);
          newsDataArticles = filterDuplicates(newsDataArticles, seenIds);
          articles = [...articles, ...newsDataArticles];
        }

        console.log(`Found ${articles.length} unique articles for ${lang}`);
        return articles;

      } catch (error) {
        console.error(`Error fetching news for ${lang}:`, error);
        return [];
      }
    }

    // Render articles
    function renderArticles(articles, container, lang) {
      if (!articles || articles.length === 0) { // Check for null or empty articles array
        if(container.innerHTML.includes('loading')) {
            container.innerHTML = `<div class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              ${lang === 'es' ? 
                'No se encontraron noticias sobre autismo en este momento.' : 
                'No autism-related news found at this time.'}
            </div>`;
        }
        return;
      }

      const fragment = document.createDocumentFragment(); // Use a fragment for performance
      articles.forEach((article, index) => {
        const card = document.createElement('div');
        card.className = 'card';
        
        const publishedDate = new Date(article.publishedAt);
        const formattedDate = !isNaN(publishedDate) ? publishedDate.toLocaleDateString(
          lang === 'es' ? 'es-ES' : 'en-US',
          { year: 'numeric', month: 'long', day: 'numeric' }
        ) : 'Fecha no disponible';
        
        const fallbackImage = 'https://www.nicepng.com/png/detail/134-1340570_autism-awareness-ribbon-vector-dia-mundial-de-conscientizao.png';
        
        // ===== MODIFICACIÓN: Añadir botón de traducción para noticias en inglés =====
        const translateButtonHtml = lang === 'en' ? `
            <button class="translate-btn"
                    data-title="${(article.title || '').replace(/"/g, '&quot;')}"
                    data-desc="${(article.description || '').replace(/"/g, '&quot;')}">
                <i class="fas fa-language"></i> Traducir al español
            </button>
        ` : '';
        // =========================================================================

        card.innerHTML = `
          <img src="${article.urlToImage || fallbackImage}" 
               alt="${article.title}" 
               loading="lazy"
               onerror="this.src='${fallbackImage}'">
          <div class="card-content">
            <span class="date">${formattedDate}</span>
            <h3>${article.title}</h3>
            <div class="source"><i class="fas fa-newspaper"></i> ${article.source.name || 'Unknown Source'}</div>
            ${article.description ? `<div class="description">${article.description}</div>` : ''}
            ${translateButtonHtml}
            <a href="${article.url}" target="_blank" rel="noopener noreferrer">
              ${lang === 'es' ? 'Leer más →' : 'Read more →'}
            </a>
          </div>
        `;
        
        fragment.appendChild(card);
        
        requestAnimationFrame(() => {
          setTimeout(() => {
            card.classList.add('visible');
          }, index * 100);
        });
      });

      if(container.querySelector('.loading')) {
          container.innerHTML = '';
      }
      container.appendChild(fragment);
    }


    // Load and display articles for Spanish
    async function loadAndShowArticlesEs() {
      if (isLoadingEs) return;
      
      isLoadingEs = true;
      loadMoreEsBtn.disabled = true;
      loadMoreEsBtn.textContent = 'Cargando...';

      try {
        apiStatus.style.display = 'block';
        const newArticlesEs = await fetchNews('es', currentPageEs);

        if (newArticlesEs.length > 0) {
          allArticlesEs = [...allArticlesEs, ...newArticlesEs];
          renderArticles(allArticlesEs, newsEsContainer, 'es'); // Render all articles
          currentPageEs++;
          loadMoreEsBtn.disabled = false;
          loadMoreEsBtn.textContent = 'Cargar más noticias';
          loadMoreEsBtn.style.display = 'block';
        } else {
          loadMoreEsBtn.style.display = 'none';
          if (currentPageEs > 1) {
            const noMoreNews = document.createElement('div');
            noMoreNews.className = 'error-message';
            noMoreNews.style.background = '#e8f5e8';
            noMoreNews.style.color = '#2e7d32';
            noMoreNews.style.borderLeftColor = '#4caf50';
            noMoreNews.innerHTML = `<i class="fas fa-info-circle"></i> No hay más noticias disponibles.`;
            loadMoreEsBtn.parentNode.insertBefore(noMoreNews, loadMoreEsBtn.nextSibling);
          }
        }

      } catch (error) {
        console.error('Error loading articles:', error);
        
        if (allArticlesEs.length === 0) {
          newsEsContainer.innerHTML = `<div class="error-message">
            <i class="fas fa-exclamation-triangle"></i> 
            Error al conectar con las APIs de noticias. Verifica tu conexión a internet.
          </div>`;
        }
        
        loadMoreEsBtn.disabled = false;
        loadMoreEsBtn.textContent = 'Cargar más noticias';
      } finally {
        isLoadingEs = false;
        apiStatus.style.display = 'none';
      }
    }

    // Load and display articles for English
    async function loadAndShowArticlesEn() {
      if (isLoadingEn) return;
      
      isLoadingEn = true;
      loadMoreEnBtn.disabled = true;
      loadMoreEnBtn.textContent = 'Loading...';

      try {
        apiStatus.style.display = 'block';
        const newArticlesEn = await fetchNews('en', currentPageEn);

        if (newArticlesEn.length > 0) {
          allArticlesEn = [...allArticlesEn, ...newArticlesEn];
          renderArticles(allArticlesEn, newsEnContainer, 'en'); // Render all articles
          currentPageEn++;
          loadMoreEnBtn.disabled = false;
          loadMoreEnBtn.textContent = 'Load more news';
          loadMoreEnBtn.style.display = 'block';
        } else {
          loadMoreEnBtn.style.display = 'none';
          
          if (currentPageEn > 1) {
            const noMoreNews = document.createElement('div');
            noMoreNews.className = 'error-message';
            noMoreNews.style.background = '#e8f5e8';
            noMoreNews.style.color = '#2e7d32';
            noMoreNews.style.borderLeftColor = '#4caf50';
            noMoreNews.innerHTML = `<i class="fas fa-info-circle"></i> No more news available.`;
            
            loadMoreEnBtn.parentNode.insertBefore(noMoreNews, loadMoreEnBtn.nextSibling);
          }
        }

      } catch (error) {
        console.error('Error loading articles:', error);
        
        if (allArticlesEn.length === 0) {
          newsEnContainer.innerHTML = `<div class="error-message">
            <i class="fas fa-exclamation-triangle"></i> 
            Error connecting to news APIs. Please check your internet connection.
          </div>`;
        }
        
        loadMoreEnBtn.disabled = false;
        loadMoreEnBtn.textContent = 'Load more news';
      } finally {
        isLoadingEn = false;
        apiStatus.style.display = 'none';
      }
    }

    // Toggle between languages
    function toggleLanguage() {
      if (columnEs.style.display === 'block' || columnEs.classList.contains('active')) {
        columnEs.style.display = 'none';
        columnEs.classList.remove('active');
        columnEn.style.display = 'block';
        columnEn.classList.add('active');
        languageToggle.innerHTML = '<i class="fas fa-language"></i> Ver en español';
        
        if (allArticlesEn.length === 0) {
          loadAndShowArticlesEn();
        }
      } else {
        columnEn.style.display = 'none';
        columnEn.classList.remove('active');
        columnEs.style.display = 'block';
        columnEs.classList.add('active');
        languageToggle.innerHTML = '<i class="fas fa-language"></i> Ver en inglés';
      }
    }

    /* ===== NUEVA FUNCIONALIDAD DE TRADUCCIÓN ===== */
    async function handleTranslation(event) {
        // Solo actuar si se hace clic en un botón de traducción
        if (!event.target.classList.contains('translate-btn')) return;

        const btn = event.target;
        const card = btn.closest('.card');
        const titleEl = card.querySelector('h3');
        const descEl = card.querySelector('.description');

        // Obtener el texto original guardado en los atributos data-*
        const originalTitle = btn.dataset.title
